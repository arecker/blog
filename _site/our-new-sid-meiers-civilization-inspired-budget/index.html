<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8"/>
    <title>Our New Sid Meier's Civilization Inspired Budget | My wife and I were inspired by Sid Meier’s Civilization to look at our finances differently.</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@alex_recker" />
    <meta name="twitter:title" content="Our New Sid Meier's Civilization Inspired Budget" />
    <meta name="twitter:description" content="My wife and I were inspired by Sid Meier’s Civilization to look at our finances differently." />
    <meta property="og:url" content="/our-new-sid-meiers-civilization-inspired-budget/" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Our New Sid Meier's Civilization Inspired Budget"/>
    <meta property="og:description" content="My wife and I were inspired by Sid Meier’s Civilization to look at our finances differently." />
    
    <link href="/assets/site.css" rel="stylesheet"/>
  </head>
  <body>
    <header>
      <h1 class="title">Our New Sid Meier's Civilization Inspired Budget</h1>
      <h2 class="subtitle">My wife and I were inspired by Sid Meier’s Civilization to look at our finances differently.</h2>
    </header>
    <hr/>
    <nav>
      
      
      <a href="/">index.html</a>
      <span> / </span>
      <span>civ-budget.html</span>
      
      <span class="float-right hide-on-mobile">
	
	<a href="/entries.html">entries.html</a>
	
	<a href="/archives.html">archives.html</a>
	
	<a href="/stats.html">stats.html</a>
	
	<a href="/contact.html">contact.html</a>
	
      </span>
      <span class="show-on-mobile">
	
	<a href="/entries.html">entries.html</a>
	
	<a href="/archives.html">archives.html</a>
	
	<a href="/stats.html">stats.html</a>
	
	<a href="/contact.html">contact.html</a>
	
      </span>
    </nav>
    <hr/>
    
    <p><strong>Edit</strong>: Hi everybody.  I had no idea our little experiment would get
so much attention.  I’ve rebooted the project in hopes of turning it
into a public tool.  Keep an eye out for the first release of
<a href="https://github.com/arecker/bennedetto">bennedetto</a> - coming soon!</p>

<hr />

<p>Any couple that says they never fight has probably never had to talk
about money. I know this because Marissa and I used to be that
couple. When you are dating, money isn’t an issue. It’s a special
occasion every time you see each other, so nobody feels guilty
springing for movie tickets, dinner, or betting on one of Wheaton’s
famous underground cock fights.</p>

<p>But now we argue about money. Arguments aren’t a bad thing. I welcome
an argument as long as something good comes out of it.</p>

<p>Money is going to add friction to any relationship, especially if you
don’t have a good system in place. I succumbed to the temptation of
allowing my checking balance to govern my mood. Every two weeks, I
would be on top of the world, then a dull panic would creep over me as
the days passed - seasoned with the occasional blowup about an expense
that I didn’t plan for that always seemed like it would be the end of
me. Then I would get paid again. It was a roller coaster, and I had no
insights into how much money we were really saving and spending.</p>

<h2 id="shopping-for-a-system">Shopping for a system</h2>

<p>Marissa and I knew that we needed a budget. At the very least, I just
needed to feel like I was trying. That way if our financial lives were
decimated I could at least point to something and say See? At least we
had a budget!</p>

<p>We spent a few months shopping around for a system we liked. Mint.com,
Dave Ramsey, free consultations - nothing quite felt right. My
complaints with whatever we were trying were usually one of these
three:</p>

<ol>
  <li><strong>Constant estimations</strong> - Most systems required us to sit down and
plan out what we were going to spend each month. There were too
many things that we simply couldn’t estimate or didn’t care to
estimate. Plus, I got tired of “babysitting” my estimations -
needing to constantly refine them.</li>
  <li><strong>Big feedback loop</strong> - Most systems are monthly. This sucked,
because we would have to go thirty days without any meaningful
information - and what information we had was almost always based
on wild estimations anyway.</li>
  <li><strong>Burden of proof</strong> - Most systems tied to our bank account, and
the numbers would look strange if we didn’t account for everything
that we were spending. Adding purchases was cumbersome. I don’t
like needing to associate everything to a category. If I buy a
stick of gum, does it go under “Food”, “Miscellaneous”, or should I
make a “Miscellaneous Food” category?</li>
</ol>

<p>Please don’t send me an email defending your favorite system. I know a
handful of people who were rescued from crippling debt by Dave Ramsey,
or who follow mint.com like it’s a religion. Whatever you use fits
your needs, but it didn’t fit ours.</p>

<h2 id="the-inspiration">The inspiration</h2>

<p>My wife and I play Sid Meier’s Civilization together - especially on
nights where we need to take our thoughts off of money. It’s one of
those turn-based games where you run a group of people, settle
somewhere on the globe, and slowly build cities and armies until you
take over everyone.</p>

<p>Each turn, the game tracks your income and expenses in food, gold, and
happiness. They are shown in an indicator bar like this.</p>

<figure>
  <a href="/images/civbar.png">
    <img alt="civbar" src="/images/civbar.png" />
  </a>
</figure>

<p>The numbers beside the gold coin represent how much gold you have in
total, as well as how much you are making or losing every
turn. Mousing over the gold coin shows a more granular breakdown of
where all your spoils are going.</p>

<figure>
  <a href="/images/civgold.png">
    <img alt="civgold" src="/images/civgold.png" />
  </a>
</figure>

<p>Certain buildings or factions cost gold to maintain, just as certain
buildings make gold. Each source of gain and loss is part of how much
gold you are making or losing per turn.</p>

<p>One night while we playing I sleepily remarked how I wish we could see
a breakdown like that for our money. I elaborated on how cool it would
be if we could pay our bills this way. I was tired of trying to assess
how we were doing financially while our account balance was jumping
around so dramatically month to month. I wished instead that money
could come in and go out more consistently - like water draining from
a faucet.</p>

<p>That got me thinking - what is stopping us from finding out how much
money we are making <em>daily</em>? If our life were a Civ game, how much
“gold” would we be making every “turn”?</p>

<h2 id="finding-the-magic-number">Finding the magic number</h2>

<p>I wanted to find out how much money we were making every day. This was
not an estimate. I was tired of estimations. I wasn’t going to attempt
to include things like gas, our electric bill, or groceries. I’m
talking about straight automated cash - like how much I would be
making if I could cryogenically freeze myself and somehow continue to
get a paycheck and pay bills.</p>

<p>My first thought was Netflix. It’s $8 a month, and it is setup to just
take money out of my PayPal account. In a scenario like this, Netflix
would continue to get their money. I made a table like this.</p>

<figure>
  <a href="/images/spreadsheet1.png">
    <img alt="spreadsheet1" src="/images/spreadsheet1.png" />
  </a>
</figure>

<p>By taking the amount due on each bill ($8), the number of days per
bill (30 - roughly a month), I could get the amount of money Netflix
costs per day by just dividing Column B by Column C - $0.26 per day.</p>

<p>Now another automatic expense. I own the domain [alexrecker.com],
which costs me $10 a year. My domain provider withdraws money from my
account when they need it. I added it to the table.</p>

<p>Using the same method, it is clear that [alexrecker.com] costs me
$0.03 a day. A sum of column D will give me a net loss of all my bills
per day - so far just Netflix and my domain.</p>

<p>I did this for every expense I could. Again, because this was a
calculated rate, only bills that were totally fixed and automated
could be included.</p>

<p>Once I had all my bills in, I added my paycheck. Summing all my daily
expenses with my daily income gave me the magic ‘gold per turn’ number
I was looking for. I was happy it was positive.</p>

<p>The best part about this number was that there was almost no
estimation involved. I didn’t have to make any wild guesses about
things I didn’t care about to get instant feedback. Knowing how much
money I get to keep in a day was already giving me a valuable
objective perspective.</p>

<h2 id="bookkeeping">Bookkeeping</h2>

<p>This number was great, but not everything in life can be automated. We
had to come up with a way to get feedback from one time purchases and
semi-regular expenses as well.</p>

<p>I opened a new LibreOffice spreadsheet that looked like this.</p>

<figure>
  <a href="/images/spreadsheet3.png">
    <img alt="spreadsheet3" src="/images/spreadsheet3.png" />
  </a>
</figure>

<p>This was where I kept track of my daily expenses. All I needed was the
date, a description of what it was (to jog my memory if I was to go
over it again), and the amount.</p>

<p>I started the new sheet with the magic daily number I calculated
before, which is a positive number. Any purchases I made that day
would be entered in as negative amounts. Likewise, if I came upon cash
it would be entered as a positive amount.</p>

<p>At the end of the day, it was safe to say that the sum of Column C
represented <strong>how much money I made that day</strong>. If it were negative, that
means I spent more money than I make in a day. If it were positive,
that means I saved.</p>

<p>What I had here was more <strong>instant</strong> feedback. Now I was keeping track
of how much I was <em>saving</em> every day.</p>

<p>Next morning, I opened a new sheet and started it like the last,
opening it with a positive transaction of the magic number. My
cellphone bill was due that day, and since the total depends on how
much data my wife and I use, that could not be part of our magic
number. I paid the bill, which made us very negative for the day.</p>

<p>While some days were negative, I could still add up each day of the
week to find out how much I saved over the past few days. If I had a
bad week, I could theoretically add up each week to get a number for
the month.</p>

<p>I rigged up the spreadsheet to give me these numbers on a summary
page.</p>

<figure>
  <a href="/images/spreadsheet4.png">
    <img alt="spreadsheet4" src="/images/spreadsheet4.png" />
  </a>
</figure>

<p>This sheet told me the running total for that day, the week, the
month, and the year. When I first started, all four numbers were
identical, but as the weeks turned over, I started to more diverse
results. While my daily total would fluctuate from exactly my magic
number in the morning to well negative when we would go out to eat,
the weekly and monthly average would even things out. As long as our
weekly and monthly total was positive, we didn’t have to worry too
much. If those started to dive, we would change our habits and keep
our daily total positive until our other numbers began to improve.</p>

<h2 id="asking-the-right-questions">Asking the right questions</h2>

<p>Here’s what I love about this system:</p>

<ol>
  <li><strong>Little estimation</strong> - There was no guessing required to get going
with this. Everything I entered was factual. Rates were limited to
automated purchases, and purchases were entered realtime with very
little overhead.</li>
  <li><strong>Small feedback loop</strong> - This system was immediately useful. We
could wake up the next day knowing how much we were going to make
and exactly how much our day-to-day purchases would compare to
that.</li>
  <li><strong>Ready for experimentation</strong> - Because the numbers were so
straight forward, we were free to look at the data and form simple
tests around it.  If I thought taking the bus every day would help
us save money, I could try it for a week and examine the results.
While categories and groups aren’t needed to add purchases, I could
certainly tack them on to whatever purchases I wanted to track -
say, comparing bus fees with money spent at the gas pump. Rather
than needing to prove everything , I could focus on one behavior at
a time and quickly see if these guesses were supported by one
clear, obvious result.</li>
</ol>

<h2 id="fun-with-data">Fun with data</h2>

<p>Our new budget has evolved quite a bit beyond my LibreOffice
spreadsheet. I’ve moved the operation to a Django web
application. This allows me to automate calculating my magic number,
opening new days, and entering in purchases. Being able to access our
budget from a mobile friendly website also makes the data entry less
painful.</p>

<p>Our dashboard lists the purchases we made that day.</p>

<figure>
  <a href="/images/moolah1.png">
    <img alt="moolah1" src="/images/moolah1.png" />
  </a>
</figure>

<p>When we make a purchase, there is a form that flips out from the
top. It was very important to me that this form include as <em>little</em>
information as possible.</p>

<figure>
  <a href="/images/moolah2.png">
    <img alt="moolah2" src="/images/moolah2.png" />
  </a>
</figure>

<p>Beside it, there is a widget to show us the running total for the day,
week, month, and year.</p>

<figure>
  <a href="/images/moolah3.png">
    <img alt="moolah3" src="/images/moolah3.png" />
  </a>
</figure>

<p>Here is the fun part. I made a few graphs to give us an idea of how we
are doing. This is a graph that shows us what our total was each day,
along with the corresponding day from last week. This is valuable when
we are picking which days we are going to go out to eat.</p>

<figure>
  <a href="/images/moolah4.png">
    <img alt="moolah4" src="/images/moolah4.png" />
  </a>
</figure>

<p>This is a break down of all the expenses and sources of income that
make up our magic number that opens each day with a positive
amount. The slices are automated expenses mixed with automated income,
but I plan on color coding it to make it a little easier to see.</p>

<figure>
  <a href="/images/moolah5.png">
    <img alt="moolah5" src="/images/moolah5.png" />
  </a>
</figure>

<p>This graph shows the progression of what the yearly savings number was
on any given day. I’m still waiting for this one to even out, but once
it does, it should give us a good idea of how much we are saving in
the long run. Ideally, we would like it to slowly climb despite daily
flux.</p>

<figure>
  <a href="/images/moolah6.png">
    <img alt="moolah6" src="/images/moolah6.png" />
  </a>
</figure>

<p>So that’s our Civ inspired budget. I’m sure you have a system of your
own, but I wanted to share ours just in case you are still shopping
for a good fit.</p>

<hr />

<h2 id="epilogue-under-the-hood">Epilogue: under the hood</h2>

<p>As I mentioned, my new budget is powered by a Django app I put
together that is getting better over time. You can view the source
<a href="https://github.com/arecker/moolah">here</a>, but I wanted to take you through a few snippets of how I got
Django and Angular to do all the work for me.</p>

<h3 id="models">Models</h3>

<p>The first model was a <code class="language-plaintext highlighter-rouge">Rate</code>. This represented an automatic expense or
income that I could factor into the daily magic number.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">uuid</span> <span class="kn">import</span> <span class="n">uuid4</span>
<span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span> <span class="nn">django.core.validators</span> <span class="kn">import</span> <span class="n">MinValueValidator</span>

<span class="k">class</span> <span class="nc">Rate</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">UUIDField</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                          <span class="n">editable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                          <span class="n">default</span><span class="o">=</span><span class="n">uuid4</span><span class="p">,</span>
                          <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">description</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">120</span><span class="p">)</span>
    <span class="n">amount</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">DecimalField</span><span class="p">(</span><span class="n">max_digits</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">decimal_places</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">days</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">PositiveIntegerField</span><span class="p">(</span><span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">MinValueValidator</span><span class="p">(</span><span class="mi">1</span><span class="p">)])</span>
    <span class="n">amount_per_day</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">DecimalField</span><span class="p">(</span><span class="n">max_digits</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                                         <span class="n">decimal_places</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                         <span class="n">editable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                         <span class="n">blank</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div>

<ol>
  <li>There is no special reason I am overriding id with a <code class="language-plaintext highlighter-rouge">UUIDField</code>. I
just prefer this over the default int because I think it looks
cooler in a database. Django’s documentation shows how to do this.</li>
  <li>I am supplying an additional validator to days to protect the model
from tripping into a situation where it is dividing by zero. As
long as this number is a positive integer, that won’t happen.</li>
</ol>

<p>I figured these <code class="language-plaintext highlighter-rouge">Rate</code> models would be <em>read</em> more often than
<em>written</em> , so I made <code class="language-plaintext highlighter-rouge">amount_per_day</code> a field as opposed to a
calculated value.</p>

<p>For this reason, a custom <code class="language-plaintext highlighter-rouge">save</code> routine on the model was needed to
populate it each time it changed.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">decimal</span> <span class="kn">import</span> <span class="n">Decimal</span>

<span class="k">class</span> <span class="nc">Rate</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>

    <span class="s">'''...rest of model...'''</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">amount_per_day</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">amount</span> <span class="o">/</span> <span class="n">Decimal</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">days</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Rate</span><span class="p">,</span> <span class="bp">self</span><span class="p">).</span><span class="n">save</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</code></pre></div></div>

<p>Next, I needed a way to sum these up. Django’s ORM supplies a handy
aggregate function, as well as a QuerySet API to make any custom
manager functions chain-able.</p>

<p>I defined a custom <code class="language-plaintext highlighter-rouge">QuerySet</code> for <code class="language-plaintext highlighter-rouge">Rate</code> and associated it to the
model using <code class="language-plaintext highlighter-rouge">.as_manager()</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>

<span class="k">class</span> <span class="nc">RateQuerySet</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">QuerySet</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">total</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">Sum</span><span class="p">(</span><span class="s">'amount_per_day'</span><span class="p">))[</span><span class="s">'amount_per_day__sum'</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">Rate</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">objects</span> <span class="o">=</span> <span class="n">RateQuerySet</span><span class="p">.</span><span class="n">as_manager</span><span class="p">()</span>
</code></pre></div></div>

<p>Now, I can filter for any conditions I want and retrieve the total
from calling my own <code class="language-plaintext highlighter-rouge">.total()</code>.</p>

<p>My second model is a <code class="language-plaintext highlighter-rouge">Transaction</code>, which represents any exchange of
money I would record.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">myapp.utils</span> <span class="kn">import</span> <span class="n">get_timestamp</span>  <span class="c1"># just gets a timezone aware datetime
</span>
<span class="k">class</span> <span class="nc">TransactionBase</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">UUIDField</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                          <span class="n">editable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                          <span class="n">default</span><span class="o">=</span><span class="n">uuid4</span><span class="p">,</span>
                          <span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">description</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">120</span><span class="p">)</span>
    <span class="n">timestamp</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">get_timestamp</span><span class="p">,</span>
                                     <span class="n">editable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">amount</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">DecimalField</span><span class="p">(</span><span class="n">max_digits</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">decimal_places</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div></div>

<p>I added a similar <code class="language-plaintext highlighter-rouge">QuerySet</code> with functions to fetch the total as well
as any helpful date range.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">TransactionQuerySet</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">QuerySet</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">total</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">aggregate</span><span class="p">(</span>
            <span class="n">models</span><span class="p">.</span><span class="n">Sum</span><span class="p">(</span><span class="s">'amount'</span><span class="p">))[</span><span class="s">'amount__sum'</span><span class="p">]</span> <span class="ow">or</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">timestamp__month</span><span class="o">=</span><span class="n">date</span><span class="p">.</span><span class="n">month</span><span class="p">,</span>
                           <span class="n">timestamp__day</span><span class="o">=</span><span class="n">date</span><span class="p">.</span><span class="n">day</span><span class="p">,</span>
                           <span class="n">timestamp__year</span><span class="o">=</span><span class="n">date</span><span class="p">.</span><span class="n">year</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">date_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">timestamp__lt</span><span class="o">=</span><span class="n">end</span><span class="p">,</span>
                           <span class="n">timestamp__gt</span><span class="o">=</span><span class="n">start</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">today</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">date</span><span class="p">(</span><span class="n">get_timestamp</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">days_ago</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">_from_today</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">this_month</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">get_timestamp</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">timestamp__month</span><span class="o">=</span><span class="n">date</span><span class="p">.</span><span class="n">month</span><span class="p">,</span>
                           <span class="n">timestamp__year</span><span class="o">=</span><span class="n">date</span><span class="p">.</span><span class="n">year</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">last_week</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">_from_today</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">last_month</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">_from_today</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">last_year</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">_from_today</span><span class="p">(</span><span class="mi">365</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_from_today</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">days</span><span class="p">):</span>
        <span class="n">today</span> <span class="o">=</span> <span class="n">get_timestamp</span><span class="p">()</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">today</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">days</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">today</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Transaciton</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">objects</span> <span class="o">=</span> <span class="n">TransactionQuerySet</span><span class="p">.</span><span class="n">as_manager</span><span class="p">()</span>
</code></pre></div></div>

<p>Because the app was restful, I knew I was going to end up sending ISO
date strings from Moment.js down to the server. I wanted to still be
able to send strings into these methods, so I decided to handle all
the str to datetime conversion in one place with a decorator and the
dateutil package.</p>

<p>The decorator <code class="language-plaintext highlighter-rouge">@sanitize_dates</code> simply attempts to parse each argument
into a datetime before invoking the <code class="language-plaintext highlighter-rouge">QuerySet</code> method.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">dateutil</span> <span class="kn">import</span> <span class="n">parser</span>

<span class="k">def</span> <span class="nf">sanitize_dates</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="s">'''
    attempt to convert stringy dates
    to real dates
    '''</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="n">clean_args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">datetime</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">parsed_date</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="n">parse</span><span class="p">(</span><span class="n">arg</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="s">'"'</span><span class="p">,</span> <span class="s">''</span><span class="p">))</span>
                    <span class="n">zoned_date</span> <span class="o">=</span> <span class="n">get_timestamp</span><span class="p">(</span><span class="n">parsed_date</span><span class="p">)</span>
                    <span class="n">clean_args</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">zoned_date</span><span class="p">)</span>
                <span class="k">except</span> <span class="nb">ValueError</span><span class="p">:</span>
                    <span class="n">clean_args</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>  <span class="c1"># just pass it in as is
</span>            <span class="k">else</span><span class="p">:</span>
                <span class="n">clean_args</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">clean_args</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapper</span>

<span class="k">class</span> <span class="nc">TransactionBaseQuerySet</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">QuerySet</span><span class="p">):</span>
    <span class="o">@</span><span class="n">sanitize_dates</span>
    <span class="k">def</span> <span class="nf">date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>  <span class="c1"># now you can send a string into me!
</span>        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="nb">filter</span><span class="p">(</span><span class="n">timestamp__month</span><span class="o">=</span><span class="n">date</span><span class="p">.</span><span class="n">month</span><span class="p">,</span>
                           <span class="n">timestamp__day</span><span class="o">=</span><span class="n">date</span><span class="p">.</span><span class="n">day</span><span class="p">,</span>
                           <span class="n">timestamp__year</span><span class="o">=</span><span class="n">date</span><span class="p">.</span><span class="n">year</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="django-rest-framework">Django Rest Framework</h3>

<p>The rest endpoints were setup with <a href="http://www.django-rest-framework.org/">django rest framework</a>. Using its
<code class="language-plaintext highlighter-rouge">ModelViewSet</code>, <code class="language-plaintext highlighter-rouge">ModelSerializer</code>, and <code class="language-plaintext highlighter-rouge">DefaultRouter</code>, it was
stupidly simple.</p>

<h3 id="angular">Angular</h3>

<p>The frontend is using angular. After logging in, the app serves up a
single <code class="language-plaintext highlighter-rouge">index.html</code> routed as a <code class="language-plaintext highlighter-rouge">TemplateView</code> . This is guided by
<code class="language-plaintext highlighter-rouge">urls.py</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">url</span>
<span class="kn">from</span> <span class="nn">django.views.generic</span> <span class="kn">import</span> <span class="n">TemplateView</span>
<span class="kn">from</span> <span class="nn">django.contrib.auth.decorators</span> <span class="kn">import</span> <span class="n">login_required</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">'''... other rules...'''</span>

    <span class="n">url</span><span class="p">(</span><span class="s">r'^$'</span><span class="p">,</span> <span class="n">login_required</span><span class="p">(</span><span class="n">TemplateView</span><span class="p">.</span><span class="n">as_view</span><span class="p">(</span><span class="n">template_name</span><span class="o">=</span><span class="s">'index.html'</span><span class="p">)))</span>
<span class="p">]</span>
</code></pre></div></div>

<p>This template serves up the static scripts, which are bundled and
minified in production by <a href="https://github.com/django-compressor/django-compressor">django-compressor</a>. The template is split
into various <code class="language-plaintext highlighter-rouge">include</code> blocks to fetch bower components and other
resources.</p>

<p>Because this is the last interface between vanilla Django and angular,
I used the template engine here to inject any urls and other constants
into the app.</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script&gt;</span>
 <span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="dl">'</span><span class="s1">moolah</span><span class="dl">'</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">constant</span><span class="p">(</span><span class="dl">'</span><span class="s1">STATIC_URL</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">/static/</span><span class="dl">'</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">constant</span><span class="p">(</span><span class="dl">'</span><span class="s1">API_URL</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">/api/</span><span class="dl">'</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">constant</span><span class="p">(</span><span class="dl">'</span><span class="s1">LOGOUT_URL</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">{% url </span><span class="dl">'</span><span class="nx">django</span><span class="p">.</span><span class="nx">contrib</span><span class="p">.</span><span class="nx">auth</span><span class="p">.</span><span class="nx">views</span><span class="p">.</span><span class="nx">logout</span><span class="dl">'</span><span class="s1"> %}</span><span class="dl">'</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">constant</span><span class="p">(</span><span class="dl">'</span><span class="s1">USER_NAME</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">{{ user.get_full_name }}</span><span class="dl">'</span><span class="p">);</span>
<span class="nt">&lt;/script&gt;</span>
</code></pre></div></div>

<p>By invoking Django’s named URLs in inline JavaScript and saving them
off into angular constants, I can avoid hard coding these or having to
query for them later.</p>

<p>To get various template paths, I made an angular service that consumes
the <code class="language-plaintext highlighter-rouge">STATIC_URL</code> constant.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="dl">'</span><span class="s1">moolah</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">factory</span><span class="p">(</span><span class="dl">'</span><span class="s1">toStatic</span><span class="dl">'</span><span class="p">,</span> <span class="p">[</span><span class="dl">'</span><span class="s1">STATIC_URL</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">STATIC_URL</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="dl">'</span><span class="s1">{}{}</span><span class="dl">'</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">STATIC_URL</span><span class="p">,</span> <span class="nx">i</span><span class="p">);</span>
        <span class="p">};</span>
    <span class="p">}]);</span>
</code></pre></div></div>

<p>Using the same method, I created a resource service to consume the
<code class="language-plaintext highlighter-rouge">API_URL</code> constant.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">angular</span>
    <span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="dl">'</span><span class="s1">moolah</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">factory</span><span class="p">(</span><span class="dl">'</span><span class="s1">TransactionService</span><span class="dl">'</span><span class="p">,</span>
             <span class="p">[</span><span class="dl">'</span><span class="s1">$resource</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">API_URL</span><span class="dl">'</span><span class="p">,</span>
              <span class="kd">function</span><span class="p">(</span><span class="nx">$resource</span><span class="p">,</span> <span class="nx">API_URL</span><span class="p">)</span> <span class="p">{</span>
                  <span class="k">return</span> <span class="nx">$resource</span><span class="p">(</span><span class="dl">'</span><span class="s1">{}transactions/:id</span><span class="dl">'</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">API_URL</span><span class="p">));</span>
              <span class="p">}]);</span>
</code></pre></div></div>

<h3 id="getting-the-reports">Getting the reports</h3>

<p>To grab miscellaneous report-like data (like the ‘Summary’ card), I
added an API path for each ‘report’. This call gets our running daily,
weekly, monthly, and yearly total.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">rest_framwork</span> <span class="kn">import</span> <span class="n">views</span><span class="p">,</span> <span class="n">response</span>
<span class="kn">from</span> <span class="nn">models</span> <span class="kn">import</span> <span class="n">Tranaction</span>

<span class="k">class</span> <span class="nc">SummaryView</span><span class="p">(</span><span class="n">views</span><span class="p">.</span><span class="n">APIView</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">Transaction</span><span class="p">.</span><span class="n">objects</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s">'day'</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">today</span><span class="p">().</span><span class="n">total</span><span class="p">(),</span>
                <span class="s">'week'</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">last_week</span><span class="p">().</span><span class="n">total</span><span class="p">(),</span>
                <span class="s">'month'</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">last_month</span><span class="p">().</span><span class="n">total</span><span class="p">(),</span>
                <span class="s">'year'</span><span class="p">:</span> <span class="n">t</span><span class="p">.</span><span class="n">last_year</span><span class="p">().</span><span class="n">total</span><span class="p">()}</span>

        <span class="k">return</span> <span class="n">response</span><span class="p">.</span><span class="n">Response</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</code></pre></div></div>

<p>This is how I’m getting that ‘this week vs. last week’ line graph.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">DailyTransactionReportView</span><span class="p">(</span><span class="n">views</span><span class="p">.</span><span class="n">APIView</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_get_week_dates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weeks</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">today</span> <span class="o">=</span> <span class="n">get_timestamp</span><span class="p">()</span>
        <span class="n">monday</span> <span class="o">=</span> <span class="n">today</span> <span class="o">+</span> <span class="n">relativedelta</span><span class="p">(</span><span class="n">weekday</span><span class="o">=</span><span class="n">MO</span><span class="p">(</span><span class="n">weeks</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">monday</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">Transaction</span><span class="p">.</span><span class="n">objects</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s">'Monday'</span><span class="p">,</span>
                  <span class="s">'Tuesday'</span><span class="p">,</span>
                  <span class="s">'Wednesday'</span><span class="p">,</span>
                  <span class="s">'Thursday'</span><span class="p">,</span>
                  <span class="s">'Friday'</span><span class="p">,</span>
                  <span class="s">'Saturday'</span><span class="p">,</span>
                  <span class="s">'Sunday'</span><span class="p">]</span>

        <span class="n">this_week</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">.</span><span class="n">date</span><span class="p">(</span><span class="n">d</span><span class="p">).</span><span class="n">total</span><span class="p">()</span>
                     <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">_get_week_dates</span><span class="p">()]</span>

        <span class="n">last_week</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">.</span><span class="n">date</span><span class="p">(</span><span class="n">d</span><span class="p">).</span><span class="n">total</span><span class="p">()</span>
                     <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">_get_week_dates</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)]</span>

        <span class="k">return</span> <span class="n">response</span><span class="p">.</span><span class="n">Response</span><span class="p">({</span><span class="s">'labels'</span><span class="p">:</span> <span class="n">labels</span><span class="p">,</span>
                                  <span class="s">'data'</span><span class="p">:</span> <span class="p">[</span><span class="n">this_week</span><span class="p">,</span>
                                           <span class="n">last_week</span><span class="p">],</span>
                                  <span class="s">'series'</span><span class="p">:</span> <span class="p">[</span><span class="s">'This Week'</span><span class="p">,</span> <span class="s">'Last Week'</span><span class="p">]})</span>
</code></pre></div></div>

<p>The reports are consumed by angular directives and handed over to
Chart.js.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="dl">'</span><span class="s1">moolah</span><span class="dl">'</span><span class="p">)</span>

    <span class="p">.</span><span class="nx">controller</span><span class="p">(</span><span class="dl">'</span><span class="s1">dailyTransactionreportController</span><span class="dl">'</span><span class="p">,</span> <span class="p">[</span><span class="dl">'</span><span class="s1">ReportService</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">ReportService</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nb">self</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

        <span class="nb">self</span><span class="p">.</span><span class="nx">cardTitle</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">This Week</span><span class="dl">'</span><span class="p">;</span>

        <span class="nx">ReportService</span><span class="p">.</span><span class="nx">dailyTransactionReport</span><span class="p">().</span><span class="nx">success</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
            <span class="nb">self</span><span class="p">.</span><span class="nx">data</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
            <span class="nb">self</span><span class="p">.</span><span class="nx">labels</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">labels</span><span class="p">;</span>
            <span class="nb">self</span><span class="p">.</span><span class="nx">series</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">series</span><span class="p">;</span>
        <span class="p">});</span>
    <span class="p">}])</span>

    <span class="p">.</span><span class="nx">directive</span><span class="p">(</span><span class="dl">'</span><span class="s1">dailyTransactionReport</span><span class="dl">'</span><span class="p">,</span> <span class="p">[</span><span class="dl">'</span><span class="s1">toStatic</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">toStatic</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="na">restrict</span><span class="p">:</span> <span class="dl">'</span><span class="s1">E</span><span class="dl">'</span><span class="p">,</span>
            <span class="na">controller</span><span class="p">:</span> <span class="dl">'</span><span class="s1">dailyTransactionreportController</span><span class="dl">'</span><span class="p">,</span>
            <span class="na">controllerAs</span><span class="p">:</span> <span class="dl">'</span><span class="s1">reportCtrl</span><span class="dl">'</span><span class="p">,</span>
            <span class="na">templateUrl</span><span class="p">:</span> <span class="nx">toStatic</span><span class="p">(</span><span class="dl">'</span><span class="s1">app/directives/daily-transaction-report.html</span><span class="dl">'</span><span class="p">),</span>
            <span class="na">bindToController</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
            <span class="na">scope</span><span class="p">:</span> <span class="p">{}</span>
        <span class="p">};</span>
    <span class="p">}]);</span>
</code></pre></div></div>

<p>The data gets bound to the controller and passed to the
angular-Chart.js API in the template.</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;moolah-card</span> <span class="na">card-title=</span><span class="s">"reportCtrl.cardTitle"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;canvas</span> <span class="na">class=</span><span class="s">"chart chart-line"</span> <span class="na">chart-data=</span><span class="s">"reportCtrl.data"</span>
          <span class="na">chart-labels=</span><span class="s">"reportCtrl.labels"</span> <span class="na">chart-legend=</span><span class="s">"true"</span>
          <span class="na">chart-series=</span><span class="s">"reportCtrl.series"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;/canvas&gt;</span>
<span class="nt">&lt;/moolah-card&gt;</span>
</code></pre></div></div>

<h3 id="automation">Automation</h3>

<p>Each morning, the app needs to create a new transaction representing
the total of all our <code class="language-plaintext highlighter-rouge">Rate</code> objects.</p>

<p>I created a <code class="language-plaintext highlighter-rouge">QuerySet</code> function off of <code class="language-plaintext highlighter-rouge">Transaction</code> to fetch the
total of all the rates and create a new <code class="language-plaintext highlighter-rouge">Transaction</code> for that amount.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">TransactionQuerySet</span><span class="p">(</span><span class="n">TransactionBaseQuerySet</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">transact_rate_balance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">transaction</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">model</span><span class="p">()</span>
        <span class="n">transaction</span><span class="p">.</span><span class="n">description</span> <span class="o">=</span> <span class="p">(</span><span class="s">'Rate Balance for {0}'</span>
                                   <span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">get_timestamp</span><span class="p">()</span>
                                           <span class="p">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">"%m/%d/%Y"</span><span class="p">)))</span>
        <span class="n">transaction</span><span class="p">.</span><span class="n">amount</span> <span class="o">=</span> <span class="n">Rate</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">total</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">transaction</span><span class="p">.</span><span class="n">save</span><span class="p">()</span>
</code></pre></div></div>

<p>Next, I created a handle for running this code using the runscript
function in <a href="http://django-extensions.readthedocs.org/en/latest/runscript.html">django-extensions</a>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">tracking.models</span> <span class="kn">import</span> <span class="n">Transaction</span>

<span class="k">def</span> <span class="nf">run</span><span class="p">():</span>
    <span class="n">Transaction</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">transact_rate_balance</span><span class="p">()</span>
</code></pre></div></div>

<p>Lastly, I created a cronjob to run the following script each day at
midnight.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="c"># moolah.sh</span>
<span class="c"># Runs moolah.scripts.rates</span>
<span class="nv">python_path</span><span class="o">=</span>/home/alex/envs/moolah/bin/python
<span class="nv">script_path</span><span class="o">=</span>/home/alex/git/moolah/manage.py
<span class="k">${</span><span class="nv">python_path</span><span class="k">}</span> <span class="k">${</span><span class="nv">script_path</span><span class="k">}</span> runscript rates
</code></pre></div></div>

<p>And that’s pretty much it!</p>


    
    <hr/>
    <footer>
      <small>Last Updated: November 27 2020, 06:48:46 PM CST</small>
      <small>
	Powered by <a href="https://github.com/arecker/blog">jekyll</a> (<a class="code" href="https://github.com/arecker/blog/commit/776a3217ead01b9c9c8ac61d14ba1a9b42cfa404">776a321</a>)
      </small>
      <small>&copy; Copyright 2020 Alex Recker</small>
    </footer>
    
  </body>
</html>
