#!/usr/bin/env bash

set -e

log() {
    echo "bump: $1" 1>&2
}

trap 'bail' ERR

bail() {
    log "script failed!"
    exit 1
}

if [[ -z "${BLOG_PATH}" ]]; then
    log "please set a BLOG_PATH=\"\""
    exit 1
else
    cd "$BLOG_PATH"
fi

BLOG_SED="${BLOG_SED:-sed}"
CURRENT_VERSION="$(cat VERSION)"

usage() {
    cat <<EOF
bump - increment the version

Usage:
    bump <major|minor|patch>
EOF
}

patch() {
    echo "$CURRENT_VERSION" | "$BLOG_SED" -E 's/([0-9]*)\.([0-9]*)\.([0-9]*)/\3/'
}

minor() {
    echo "$CURRENT_VERSION" | "$BLOG_SED" -E 's/([0-9]*)\.([0-9]*)\.([0-9]*)/\2/'
}

major() {
    echo "$CURRENT_VERSION" | "$BLOG_SED" -E 's/([0-9]*)\.([0-9]*)\.([0-9]*)/\1/'
}

latest_tag() {
    git describe --abbrev=0
}

print_changelog() {
    git shortlog "$(latest_tag)..HEAD"
}

print_commit_message() {
    cat <<EOF
${MESSAGE_TOPIC}

${MESSAGE_BODY}
EOF
}

create_release_payload() {
    cat <<EOF
{
  "tag_name": "${TAG}",
  "name": "${NEXT_VERSION}",
  "body": "${MESSAGE_TOPIC}",
  "draft": false,
  "prerelease": false
}
EOF
}

create_release() {
    local url="https://api.github.com/repos/arecker/blog/releases"
    local response_url=`curl \
          -s \
          -H "Authorization: token $(pass github/blog)" \
          -H "application/vnd.github.v3+json" \
          -H "Content-Type:application/json" \
          -X POST \
          -d "$(create_release_payload)" \
          "$url" | jq -r '.upload_url'`
    local upload_url="$(echo $response_url | sed 's|{?name,label}||')"
    for binary in blog-darwin blog-linux blog-freebsd; do
        curl \
            -s \
            -X POST \
            -H "Authorization: token $(pass github/blog)" \
            -H "application/vnd.github.v3+json" \
            -H "Content-Type:application/json" \
            --data-binary @bin/${binary} \
            "${upload_url}?name=${binary}"
    done
}

case "$1" in
    "major")
        NEXT_VERSION="$((( $(major) + 1 ))).$(minor).$(patch)"
        ;;
    "minor")
        NEXT_VERSION="$(major).$((( $(minor) + 1 ))).$(patch)"
        ;;
    "patch")
        NEXT_VERSION="$(major).$(minor).$((( $(patch) + 1 )))"
        ;;
    *)
        usage
        exit 1
        ;;
esac

log "bumping $1 version [${CURRENT_VERSION} -> ${NEXT_VERSION}]"

MESSAGE_TOPIC="bump $1: ${CURRENT_VERSION} -> ${NEXT_VERSION}"
MESSAGE_BODY="$(print_changelog)"
MESSAGE_FULL="$(print_commit_message)"
TAG="v${NEXT_VERSION}"
REMOTE="origin"
BRANCH="master"

log "running tests"
make -B test &> /dev/null

log "writing VERSION file [${NEXT_VERSION}]"
echo "${NEXT_VERSION}" > VERSION

log "updating src/version.go [const VERSION = \"${NEXT_VERSION}\"]"
"$BLOG_SED" -i "s/$CURRENT_VERSION/$NEXT_VERSION/" src/version.go

log "building binaries"
make -B binaries &> /dev/null

log "writing commit [${MESSAGE_TOPIC}]"
git add -A &> /dev/null
git commit -m "${MESSAGE_FULL}" &> /dev/null

log "creating tag [$TAG]"
git tag -a "$TAG" -m "${MESSAGE_FULL}" &> /dev/null

log "pushing [$REMOTE:$BRANCH]"
git push --atomic "$REMOTE" "$BRANCH" "v${NEXT_VERSION}" &> /dev/null

log "creating release"
create_release &> /dev/null
