#!/usr/bin/env bash
set -e

log() {
    echo "blog-deploy: $1" 1>&2
}

goose() {
    uname | awk '{print tolower($0)}'
}

release() {
    echo "v$(cat VERSION)"
}

bin_release() {
    "$BIN_TARGET" -version  | awk '{ print $3 }'
}

bin_matches_release() {
    [ $(bin_release) == "$(release)" ]
}

bin_download() {
    wget -O "$BIN_TARGET" "$BIN_URL" &> /dev/null
    log "making $BIN_TARGET executable"
    chmod +x "$BIN_TARGET"
}

BIN_NAME="blog-$(goose)"
BIN_TARGET="./bin/blog"
BIN_URL="https://github.com/arecker/blog/releases/download/$(release)/${BIN_NAME}"

if test -f "$BIN_TARGET"; then
    if bin_matches_release; then
        log "$BIN_TARGET exists and matches release ($(release))"
    else
        log "$BIN_TARGET is an old version ($(bin_release)), downloading latest release ($(release))"
        bin_download
    fi
else
    log "$BIN_TARGET not found, downloading from latest release"
    bin_download
fi

log "running $BIN_TARGET"
"$BIN_TARGET" -all

log "[legacy] building remaining datafiles"
make xml
make data

log "[legacy] building jekyll"
bundle exec jekyll build
